## LAB10-1. Развертывание почтового сервера
0. Перед началом выполнения лабораторной работы добавьте следующие записи в зону на своем dns-сервере. 
```conf
s3 A 172.16.110.your-IP
mail A 172.16.110.your-IP
@  MX 10 mail.yuordomain.local
```
А также убедитесь что все хосты используют локальный dns-сервер.
   
1.  **Подключитесь к серверу `s3`**. Установите пакет **postfix**
```bash
sudo dnf update
sudo dnf install postfix -y
sudo systemctl start postfix
sudo systemctl enable postfix
systemctl status postfix
```
2.  Добавьте **postfix** в автозапуск и запустите сервис.
```bash
sudo systemctl enable postfix
systemctl status postfix
```
3.  Проверьте версию Postfix
```bash
postconf mail_version
```
4.  **Postfix** поставляется со многими "бинари"-файлами в каталоге **/usr/sbin/**
```bash
rpm -ql postfix | grep /usr/sbin/
```
5.  **master**-процесс **Postfix** прослушивает TCP-порт **25** локального хоста.
```bash
sudo ss -lnpt | grep master
```
6.  **postconf** - это утилита настройки **Postfix**, которая может отображать значение параметров в основном файле конфигурации **Postfix** (`/etc/postfix/main.cf`). Опция **-e** позволяет **postconf** редактировать основной файл конфигурации **Postfix**.
```bash
postconf inet_interfaces

inet_interfaces = localhost
```
7.  Выполните следующую команду, чтобы настроить **Postfix** для прослушивания общедоступного IP-адреса, чтобы он мог получать электронные письма с других SMTP-серверов.
```bash
sudo postconf -e "inet_interfaces = all"
```
8.  **Postfix** использует это имя хоста для идентификации себя при взаимодействии с другим SMTP-сервером. Однако имя хоста ОС может измениться, поэтому рекомендуется установить имя хоста непосредственно в конфигурационном файле **Postfix**.
```bash
postconf myhostname
sudo postconf -e "myhostname = mail.yourdomain.com"
```
> mail.yourdomain.com - замените на свое имя сервера
9.  Параметр `$mydomain` указывает локальное доменное имя Интернета.
```bash
postconf mydomain
sample.com
sudo postconf -e "mydomain = yourdomain.com"
```
10. Параметр `$myorigin` указывает доменное имя по умолчанию, которое будет добавлено к адресам отправителей и получателей, которые не имеют части `@domain`. Вам нужно изменить его значение на **yourdomain.com**, чтобы у отправителя на вашем почтовом сервере был адрес **@yourdomain.com**.
```bash
postconf myorigin

myorigin = $myhostname

sudo postconf -e "myorigin = yourdomain.com"
```
11. Параметр `$mydestination` определяет список доменов, для которых ваш сервер считает конечным пунктом назначения. Значение по умолчанию позволяет вашему SMTP-серверу Postfix получать электронные письма, приходящие для **someone@mail.yourdomain.com**, **someone@localhost.yourdomain.com** и **someone@localhost**, но оно не позволит вашему SMTP-серверу Postfix получать электронные письма, приходящие для **someone@yourdomain.com**. Для этого добавьте **yourdomain.com** в список доменов.
```bash
postconf mydestination

mydestination = $myhostname, localhost.$mydomain, localhost

sudo postconf -e "mydestination = yourdomain.com, \$myhostname, localhost.\$mydomain, localhost"
```
12. Перезапустите **Postfix**, чтобы изменения вступили в силу.
13. Входящий TCP-порт **25** должен быть открыт, чтобы **Postfix** мог получать электронные письма с других SMTP-серверов.
```bash
sudo firewall-cmd --permanent --add-port=25/tcp
sudo systemctl reload firewalld
```
14. Почтовый журнал **Postfix** хранится в `/var/log/maillog`. Разделите экран на два терминала(если вы используете **tmux**) или откройте еще один терминал и запустите просмотр и следование журналу postfix, чтобы видеть сообщения сервиса.
```bash
sudo tail -f /var/log/maillog
```
15. **Отправка тестового электронного письма**. При установке **Postfix** двоичный файл **sendmail** помещается в `/usr/sbin/sendmail`, который совместим с традиционным SMTP-сервером Sendmail. Вы можете использовать двоичный файл sendmail` Postfix для отправки тестового электронного письма на свою учетную запись Gmail следующим образом:
```bash
echo "test email" | sendmail your-account@gmail.com
```
16. Установите консольного почтового агента  пользователя MUA (mail user agent). Это может быть **mailx** или **mutt**.
```bash
sudo dnf install mailx mutt
```
17. Чтобы отправить электронное письмо, введите 
Введите строку темы и основной текст. Чтобы сообщить почте, что вы закончили писать, нажмите **`Ctrl+D`**, и почта отправит вам это сообщение электронной почты.
```bash
student@mail:~$ mail username@yourdomain.com
Cc: 
Subject: 2nd test email
I'm sending this email using the mail program.
```
> в качестве поулучателя, укажите любого локального пользователя, в которого можете в последующем переключиться для проверки получения, если такого пользователя нет - создайте его.
18. Переключитесь в пользователя **username** или любого другого, которого вы указали в качестве получателя письма и проверьте почту:
```bash
su - username
mutt
```
>![Screenshot](../img/scr.png)
***Cделайте скриншот экрана c результатом выполнения задания для отправки отчета.***

19.  Чтобы прочитать входящие электронные письма, просто введите `mail`.
>- Чтобы прочитать первое сообщение электронной почты, введите **1**. Вы увидите как заголовки электронной почты, так и тело электронной почты. Если отображаются только части сообщения, нажмите **Enter**, чтобы показать оставшуюся часть сообщения.
>- Чтобы отобразить заголовки сообщений, начиная с сообщения 1, введите **h**.
>- Чтобы показать последний экран сообщений, введите **h$** или **z**.
>- Чтобы прочитать следующее сообщение электронной почты, введите **n**.
>- Чтобы удалить сообщение 1, введите **d 1**.
>- Чтобы удалить сообщение 1, 2 и 3, введите **d 1 2 3**.
>- Чтобы удалить сообщения от 1 до 10, введите **d 1-10**.
>- Чтобы воспроизвести сообщение 1, введите **reply 1**.
>- Чтобы выйти из почты, введите **q**.
20.   По умолчанию вложение не может превышать 10 МБ, чтобы разрешить вложение размером 50 МБ, выполните следующую команду
```bash
postconf message_size_limit

message_size_limit = 10240000

sudo postconf -e message_size_limit=52428800
```
21. Обратите внимание, что `message_size_limit` не должен быть больше `mailbox_size_limit`, иначе Postfix может не получать электронные письма. Установите значение **0**, чтобы почтовый ящик не имел ограничений по размеру.
```bash
postconf mailbox_size_limit

mailbox_size_limit = 51200000

sudo postconf -e mailbox_size_limit=0
```

22. Перезапустите Postfix, чтобы изменения вступили в силу.

#### Установите Dovecot IMAP Server на RHEL 8 и включите шифрование TLS
23. Открыть порты, связанные с электронной почтой, в **Firewal**
```bash
sudo firewall-cmd --permanent --add-service={http,https,smtp-submission,smtps,imap,imaps}
```
24. **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях этот шаг необходимо пропустить**. Включение шифрования - это всегда хорошая идея. Мы можем легко получить бесплатный сертификат TLS от Let's Encrypt. Выполните следующие команды для установки клиента Let's Encrypt
25. Чтобы отправлять электронные письма с настольного почтового клиента, нам необходимо включить службу отправки Postfix, чтобы почтовый клиент мог отправлять электронные письма на SMTP-сервер Postfix. Отредактируйте файл **master.cf**.
```bash
sudo vim /etc/postfix/master.cf
```
В разделе отправки отмените или добавьте следующие строки. Пожалуйста, разрешите хотя бы одно пробельное пространство (tab или пробел) перед каждым **-o**. В постфиксных конфигурациях **предшествующий пробел** означает, что эта строка является продолжением предыдущей строки.
```conf
submission     inet     n    -    y    -    -    smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_tls_wrappermode=no
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
```
Вышеуказанная конфигурация позволяет отправлять демон Postfix и требует шифрования **TLS**. Таким образом, позже наш настольный почтовый клиент может подключиться к демону отправки в TLS-шифровании. Демон отправки слушает TCP-порт **587**. **STARTTLS** используется для шифрования связи между почтовым клиентом и демоном отправки.

**Microsoft Outlook** поддерживает отправку только через порт **465**. Если вы собираетесь использовать почтовый клиент Microsoft Outlook, вам также необходимо включить службу отправки на порту **465**, добавив в файл следующие строки.
```conf
smtps     inet  n       -       y       -       -       smtpd
  -o syslog_name=postfix/smtps
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
```
Сохраните и закройте файл.

26. **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях этот шаг необходимо пропустить**. Нам нужно выполнить следующие две команды, чтобы указать местоположение сертификата **TLS** и закрытого ключа в конфигурационном файле Postfix. Ваш сертификат Let's Encrypt и закрытый ключ хранятся в каталоге `/etc/letsencrypt/live/mail.your-domain.com/`.
```bash
sudo postconf "smtpd_tls_cert_file = /etc/letsencrypt/live/mail.your-domain.com/fullchain.pem"

sudo postconf "smtpd_tls_key_file = /etc/letsencrypt/live/mail.your-domain.com/privkey.pem"
```
27. Если вы хотите регистрировать **TLS**-подключения в почтовом журнале `/var/log/maillog`, выполните следующие две команды.
```bash
sudo postconf "smtpd_tls_loglevel = 1"

sudo postconf "smtp_tls_loglevel = 1"
```

28. Чтобы отключить небезопасные версии **SSL/TLS**, откройте основной файл конфигурации Postfix.
```bash
sudo nano /etc/postfix/main.cf
```
Добавьте следующие строки в нижней части файла.
```conf
#Force TLSv1.3 or TLSv1.2
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
```
Сохраните и закройте файл. Затем перезагрузите Postfix, чтобы изменения вступили в силу.

29. Введите следующую команду, чтобы установить **Dovecot** на сервер CentOS 8/RHEL 8.
```bash
sudo dnf install dovecot -y
dovecot --version

2.3.20 (9df20d2db)

sudo systemctl start dovecot

sudo systemctl enable dovecot
```
30. Настройте Dovecot
```bash
sudo nano /etc/dovecot/dovecot.conf
```
Найдите следующую строку и раскоментируйте
```conf
#protocols = imap pop3 lmtp submission
```
Измените эту строку на следующую, чтобы включить протокол **IMAP** и протокол **LMTP**, **smtp**. 
```conf
protocols = imap pop3 lmtp
```
31. Настройка местоположения почтового ящика. **Mbox** - это традиционный формат по умолчанию для хранения электронной почты. Электронные письма каждого пользователя хранятся в одном файле `/var/mail/username`. Однако в настоящее время почти всегда вы хотите использовать формат **Maildir** для хранения сообщений электронной почты. Файл конфигурации для местоположения почтового ящика - `/etc/dovecot/conf.d/10-mail.conf`.
```bash
sudo nano /etc/dovecot/conf.d/10-mail.conf
```
Добавьте следующую строку, чтобы использовать формат **Maildir**. Сообщения электронной почты будут храниться в каталоге **Maildir** в домашнем каталоге каждого пользователя.
```conf
mail_location = maildir:~/Maildir
mail_privileged_group = mail
```
32.  Сохраните и закройте файл. Затем добавьте **dovecot** в группу **mail**, чтобы Dovecot мог прочитать **INBOX**.
```bash
sudo gpasswd -a dovecot mail
```
33.  Хотя мы настроили Dovecot на хранение электронной почты в формате **Maildir**, по умолчанию Postfix использует свой встроенный локальный агент доставки (LDA) для перемещения входящих сообщений в хранилище сообщений (**inbox**, **sent**, **trash**, **Junk** и т. д.), и они будут сохранены в формате **mbox**.

Нам нужно настроить Postfix для передачи входящих писем в Dovecot по протоколу **LMTP**, который является упрощенной версией **SMTP**, чтобы входящие электронные письма сохранялись в формате **Maildir** от Dovecot. **LMTP** обеспечивает высокомасштабируемую и надежную почтовую систему. Это также позволяет нам использовать плагин sieve для фильтрации входящих сообщений в разные папки.
Отредактируйте файл Dovecot `10-master.conf`.
```bash
sudo nano /etc/dovecot/conf.d/10-master.conf
```
Измените определение службы **lmtp** на следующее:
```c
service lmtp {
 unix_listener /var/spool/postfix/private/dovecot-lmtp {
   mode = 0600
   user = postfix
   group = postfix
  }
}
```
34. Сохраните и закройте файл. Затем отредактируйте основной файл конфигурации Postfix.
```bash
sudo nano /etc/postfix/main.cf
```
Добавьте следующие строки в конце файла. Первая строка говорит Postfix доставлять электронные письма в локальное хранилище сообщений через сервер dovecot **LMTP**. Вторая строка отключает **SMTPUTF8** в Postfix, потому что **Dovecot-LMTP** не поддерживает это расширение электронной почты.
```bash
mailbox_transport = lmtp:unix:private/dovecot-lmtp
smtputf8_enable = no
```
Сохраните и закройте файл.

35. Настройка механизма аутентификации и аутентификации. Отредактируйте файл конфигурации аутентификации.
```bash
sudo nano /etc/dovecot/conf.d/10-auth.conf
```
Найдите следующую строку и раскомментировняйте ее, удалив символ **`#`** в начале.
```bash
#disable_plaintext_auth = yes
```
Это отключит аутентификацию открытого текста при отсутствии шифрования **SSL/TLS**. Затем найдите следующую строку
```bash
#auth_username_format = %Lu
```
Раскомментировать его и изменить его значение на **`%n`**.
```bash
auth_username_format = %n
```
>По умолчанию, когда Dovecot пытается найти или доставить электронные письма для пользователя, он использует полный адрес электронной почты. Поскольку в этой части мы настроили только канонических пользователей почтовых ящиков (используя пользователей ОС в качестве пользователей почтовых ящиков), Dovecot не может найти пользователя почтового ящика в полном формате домена (**username@your-domain.com**), поэтому нам нужно установить `auth_username_format = %n`, чтобы удалить доменную часть, тогда Doveco Это также позволяет нам использовать полный адрес электронной почты (**username@your-domain.com**) для входа в систему.

36. Затем найдите следующую строку. 
```conf
auth_mechanisms = plain
```
Эта строка включает только механизм аутентификации **plain**. **login** - это еще один механизм аутентификации, который вы, вероятно, захотите добавить для поддержки старых почтовых клиентов.
```conf
auth_mechanisms = plain login
```
Сохраните и закройте файл.
37. Настройка шифрования **SSL/TLS**
```
sudo nano /etc/dovecot/conf.d/10-ssl.conf
```
Найдите следующие две строки
```c
ssl_cert = </etc/pki/dovecot/certs/dovecot.pem
ssl_key = </etc/pki/dovecot/private/dovecot.pem
```
Нам нужно заменить значения местоположением вашего сертификата SSL/TLS и закрытого ключа. Не забудьте символ **<**. Это необходимо.  **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях это редактирование необходимо пропустить**.
```
ssl_cert = </etc/letsencrypt/live/mail.your-domain.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.your-domain.com/privkey.pem
```
38. Найдите следующую строку и раскомментьте ее. (Удалите начальный символ **`#`**.)
```bash
#ssl_dh = </etc/dovecot/dh.pem
```

39. Найдите следующую строку.
```bash
#ssl_min_protocol = TLSv1
```
Это определяет минимальные версии **TLS**, используемые Dovecot. **TLSv1.0** и **TLSv1.1** небезопасны. поэтому раскомментировать эту строку и измените значение на **TLSv1.2**, что заставит Dovecot использовать **TLSv1.2** или **TLSv1.3**.
```bash
ssl_min_protocol = TLSv1.2
```

40. Найдите следующую строку.
```bash
#ssl_prefer_server_ciphers = no
```
Рекомендуется предпочесть порядок шифров сервера клиентскому, поэтому раскомментируйте эту строку и измените значение на yes.
```bash
ssl_prefer_server_ciphers = yes
```
Сохраните и закройте файл. 

41. Теперь нам нужно сгенерировать параметр **Диффи-Хеллмана** с помощью:
```bash
sudo openssl dhparam -out /etc/dovecot/dh.pem 4096
```
Если ваш почтовый сервер имеет одно ядро процессора, то это займет много времени (около 10 минут).
>Хотя существует несколько протоколов, которые предоставляют гарантии безопасности, хорошие требуют, чтобы стороны договорились о каком-либо общем секрете, прежде чем любые пользовательские данные могут быть зашифрованы и защищены целостностью.
>Существует два метода, обычно используемых для согласования общих секретов: попросите одну сторону использовать какой-то долгосрочный асимметричный ключ для шифрования секрета и отправки его владельцу ключа (как при обмене ключами RSA), или попросите обе стороны обмениваться сообщениями, которые способствуют вычисленному общему секрету (То, что мы называем обменом ключами Диффи-Хеллмана).
Безопасность обоих методов зависит от выбора правильных чисел. В одном варианте обмена ключами Диффи-Хеллмана одним из параметров должно быть большое простое число. Поскольку обмен ключами уязвим для атак, если число не является простым или не является особым простым, команда Red Hat Crypto разработала инструмент для математического доказательства того, что числа, которые мы распространяем, действительно являются простыми числами этого специального типа и, следовательно, не являются самым слабым звеном в безопасности систем, которые зависят от них. 
https://www.redhat.com/en/blog/understanding-and-verifying-security-diffie-hellman-parameters
https://ru.wikipedia.org/wiki/Протокол_Диффи_—_Хеллмана


42. Аутентификация **SASL** между Postfix и Dovecot
```bash
sudo nano /etc/dovecot/conf.d/10-master.conf
```
Измените раздел аутентификации службы на следующий, чтобы Postfix мог найти сервер аутентификации Dovecot. Пожалуйста, будьте осторожны с синтаксисом. Каждая открывающая скобка должна быть прекращена закрывающей скобкой.
```c
service auth {
    unix_listener /var/spool/postfix/private/auth {
      mode = 0600
      user = postfix
      group = postfix
    }
}
```
Сохраните и закройте файл. 
>**SASL (англ. Simple Authentication and Security Layer — простой уровень аутентификации и безопасности)** — это фреймворк (каркас) для предоставления аутентификации и защиты данных в протоколах на основе соединений. Он разделяет механизмы аутентификации от прикладных протоколов, в теории позволяя любому механизму аутентификации, поддерживающему SASL, быть использованным в любых прикладных протоколах, которые используют SASL. Фреймворк также предоставляет слой защиты данных. Для использования SASL протокол включает команду для идентификации и аутентификации пользователя на сервере и для опциональной защиты переговоров последующей интерактивности протокола. Если это используется в переговорах, то слой безопасности вставляется между протоколом и соединением.


43.  Автоматическое создание папок **Sent** и **Trash**
```bash
sudo nano /etc/dovecot/conf.d/15-mailboxes.conf
```
Чтобы автоматически создать папку, просто добавьте следующую строку в раздел почтового ящика.
```bash
auto = create
```
Пример:
```c
 mailbox Trash {
    auto = create
    special_use = \Trash
 }
```
Некоторые распространенные папки, которые вы хотите создать, включают в себя: **Drafts**, **Junk**, **Trash** и **Sent**. Папка "**Отправлено**" будет создана в домашнем каталоге пользователя, когда пользователь отправит первое электронное письмо. Папка "**Корзина**" будет создана, когда пользователь впервые удалит электронное письмо и т. д. После сохранения и закрытия всех вышеперечисленных конфигурационных файлов перезапустите Postfix и Dovecot.

44. **Подключитесь к серверу `s1`**. Установите почтовый клиент **Thunderbird**.
45. Запустите свой настольный почтовый клиент, такой как Mozilla Thunderbird. Перейдите в **Edit -> Account Settings -> Account Actions -> Add Mail Account**, чтобы добавить учетную запись почты. Если Thunderbird нашел конфигурацию вашего почтового сервера, как показано ниже, просто нажмите кнопку Готово, и вы сможете читать и отправлять электронные письма. Добавьте учетную запись **student@yourdomain.com** и **labuser@yourdomaun.com** (предварительно на сервере **s3** создаейте этого пользователя или используйте любую другую локальную учетную запись, созданную ранее, например devops - не забудьте задать пароль для пользовательского аккаунта). Если будет сообщение об ошибке самоподписанного сертификата - подтвердите доверие этому сертификату.
![thunderbird](../img/lab10-45.png)
46. Создайте и отправьте письмо от **student** пользователю **labuser**. Убедитесь, что письмо пришло.
>![Screenshot](../img/scr.png)
***Cделайте скриншот экрана c результатом выполнения задания для отправки отчета.***
