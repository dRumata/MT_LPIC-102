## LAB071. Развертывание почтового сервера
0. Перед началом выполнения лабораторной работы добавьте следующие записи в зону на своем dns-сервере. Или на общем DNS-сервере учебного класса. 

Для выполнения практики понадобится сервер (в инструкции используется имя `s1-alma`, вы можете использовать свои имена) и клиент(в инструкции используется имя `s2-deb`, вы можете использовать свои имена).

- s1-alma - ВМ с ос Almalinux 

- s2-deb - ВМ с ос Debian

> ***Внимание: адреса и имена могут отличаться в зависимости от того как организован класс. Рекомендуется воспользоваться заготовленными конфигурациями dns-сервера.***
```conf
s1-alma A 172.16.110.your-IP
mail A 172.16.110.your-IP
@  MX 10 mail.yuordomain.local
```
А также убедитесь что все хосты используют локальный dns-сервер. Если не используете dns-сервер добавьте строку в файл /etc/hosts

```
AAA.BBB.CCC.DDD mail.yourdomain.local
```
где **AAA.BBB.CCC.DDD** - ваш IP-адрес, **mail.yourdomain.local** - FQDN имя хоста (короткое имя замените на mail)
Пример файла:
```
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
172.16.110.132 s2-deb
172.16.110.131 mail mail.mt.local s1-alma.mt.local
```

#### Установите Dovecot IMAP Server на RHEL 8 и включите шифрование TLS

1. Откройте порты, связанные с электронной почтой, в **Firewal**
```bash
sudo firewall-cmd --permanent --add-service={http,https,smtp-submission,smtps,imap,imaps}
```

2. **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях этот шаг необходимо пропустить**. Включение шифрования - это всегда хорошая идея. Мы можем легко получить бесплатный сертификат TLS от Let's Encrypt. Выполните следующие команды для установки клиента Let's Encrypt

3. Чтобы отправлять электронные письма с настольного почтового клиента, нам необходимо включить службу отправки Postfix, чтобы почтовый клиент мог отправлять электронные письма на SMTP-сервер Postfix. Отредактируйте файл **master.cf**.
```bash
sudo vim /etc/postfix/master.cf
```
В разделе отправки отмените или добавьте следующие строки. Пожалуйста, разрешите хотя бы одно пробельное пространство (tab или пробел) перед каждым **-o**. В постфиксных конфигурациях **предшествующий пробел** означает, что эта строка является продолжением предыдущей строки.
```conf
submission     inet     n    -    y    -    -    smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_tls_wrappermode=no
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
```
Вышеуказанная конфигурация позволяет отправлять демон Postfix и требует шифрования **TLS**. Таким образом, позже наш настольный почтовый клиент может подключиться к демону отправки в TLS-шифровании. Демон отправки слушает TCP-порт **587**. **STARTTLS** используется для шифрования связи между почтовым клиентом и демоном отправки.

**Microsoft Outlook** поддерживает отправку только через порт **465**. Если вы собираетесь использовать почтовый клиент Microsoft Outlook, вам также необходимо включить службу отправки на порту **465**, добавив в файл следующие строки.
```conf
smtps     inet  n       -       y       -       -       smtpd
  -o syslog_name=postfix/smtps
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
```
Сохраните и закройте файл.

4. **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях этот шаг необходимо пропустить**. Нам нужно выполнить следующие две команды, чтобы указать местоположение сертификата **TLS** и закрытого ключа в конфигурационном файле Postfix. Ваш сертификат Let's Encrypt и закрытый ключ хранятся в каталоге `/etc/letsencrypt/live/mail.your-domain.com/`.
```bash
sudo postconf "smtpd_tls_cert_file = /etc/letsencrypt/live/mail.your-domain.com/fullchain.pem"

sudo postconf "smtpd_tls_key_file = /etc/letsencrypt/live/mail.your-domain.com/privkey.pem"
```

5. Если вы хотите регистрировать **TLS**-подключения в почтовом журнале `/var/log/maillog`, выполните следующие две команды.
```bash
sudo postconf "smtpd_tls_loglevel = 1"

sudo postconf "smtp_tls_loglevel = 1"
```

6. Чтобы отключить небезопасные версии **SSL/TLS**, откройте основной файл конфигурации Postfix.
```bash
sudo nano /etc/postfix/main.cf
```
Добавьте следующие строки в нижней части файла.
```conf
#Force TLSv1.3 or TLSv1.2
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
```
Сохраните и закройте файл. Затем перезагрузите Postfix, чтобы изменения вступили в силу.

1. Введите следующую команду, чтобы установить **Dovecot** на сервер.
```bash
sudo dnf install dovecot -y
dovecot --version

2.3.20 (9df20d2db)

sudo systemctl start dovecot

sudo systemctl enable dovecot
```

8. Настройте Dovecot
```bash
sudo nano /etc/dovecot/dovecot.conf
```
Найдите следующую строку и раскоментируйте
```conf
#protocols = imap pop3 lmtp submission
```
Измените эту строку на следующую, чтобы включить протокол **IMAP** и протокол **LMTP**, **smtp**. 
```conf
protocols = imap pop3 lmtp
```

9. Настройка местоположения почтового ящика. **Mbox** - это традиционный формат по умолчанию для хранения электронной почты. Электронные письма каждого пользователя хранятся в одном файле `/var/mail/username`. Однако в настоящее время почти всегда вы хотите использовать формат **Maildir** для хранения сообщений электронной почты. Файл конфигурации для местоположения почтового ящика - `/etc/dovecot/conf.d/10-mail.conf`.
```bash
sudo nano /etc/dovecot/conf.d/10-mail.conf
```
Добавьте следующую строку, чтобы использовать формат **Maildir**. Сообщения электронной почты будут храниться в каталоге **Maildir** в домашнем каталоге каждого пользователя.
```conf
mail_location = maildir:~/Maildir
mail_privileged_group = mail
```

10.  Сохраните и закройте файл. Затем добавьте **dovecot** в группу **mail**, чтобы Dovecot мог прочитать **INBOX**.
```bash
sudo gpasswd -a dovecot mail
```

11.  Хотя мы настроили Dovecot на хранение электронной почты в формате **Maildir**, по умолчанию Postfix использует свой встроенный локальный агент доставки (LDA) для перемещения входящих сообщений в хранилище сообщений (**inbox**, **sent**, **trash**, **Junk** и т. д.), и они будут сохранены в формате **mbox**.

Нам нужно настроить Postfix для передачи входящих писем в Dovecot по протоколу **LMTP**, который является упрощенной версией **SMTP**, чтобы входящие электронные письма сохранялись в формате **Maildir** от Dovecot. **LMTP** обеспечивает высокомасштабируемую и надежную почтовую систему. Это также позволяет нам использовать плагин sieve для фильтрации входящих сообщений в разные папки.
Отредактируйте файл Dovecot `10-master.conf`.
```bash
sudo nano /etc/dovecot/conf.d/10-master.conf
```
Измените определение службы **lmtp** на следующее:
```c
service lmtp {
 unix_listener /var/spool/postfix/private/dovecot-lmtp {
   mode = 0600
   user = postfix
   group = postfix
  }
}
```

12. Сохраните и закройте файл. Затем отредактируйте основной файл конфигурации Postfix.
```bash
sudo nano /etc/postfix/main.cf
```
Добавьте следующие строки в конце файла. Первая строка говорит Postfix доставлять электронные письма в локальное хранилище сообщений через сервер dovecot **LMTP**. Вторая строка отключает **SMTPUTF8** в Postfix, потому что **Dovecot-LMTP** не поддерживает это расширение электронной почты.
```bash
mailbox_transport = lmtp:unix:private/dovecot-lmtp
smtputf8_enable = no
```
Сохраните и закройте файл.

13. Настройка механизма аутентификации и аутентификации. Отредактируйте файл конфигурации аутентификации.
```bash
sudo nano /etc/dovecot/conf.d/10-auth.conf
```
Найдите следующую строку и раскомментировняйте ее, удалив символ **`#`** в начале.
```bash
#disable_plaintext_auth = yes
```
Это отключит аутентификацию открытого текста при отсутствии шифрования **SSL/TLS**. Затем найдите следующую строку
```bash
#auth_username_format = %Lu
```
Раскомментировать его и изменить его значение на **`%n`**.
```bash
auth_username_format = %n
```
>По умолчанию, когда Dovecot пытается найти или доставить электронные письма для пользователя, он использует полный адрес электронной почты. Поскольку в этой части мы настроили только канонических пользователей почтовых ящиков (используя пользователей ОС в качестве пользователей почтовых ящиков), Dovecot не может найти пользователя почтового ящика в полном формате домена (**username@your-domain.com**), поэтому нам нужно установить `auth_username_format = %n`, чтобы удалить доменную часть, тогда Doveco Это также позволяет нам использовать полный адрес электронной почты (**username@your-domain.com**) для входа в систему.

14. Затем найдите следующую строку. 
```conf
auth_mechanisms = plain
```
Эта строка включает только механизм аутентификации **plain**. **login** - это еще один механизм аутентификации, который вы, вероятно, захотите добавить для поддержки старых почтовых клиентов.
```conf
auth_mechanisms = plain login
```
Сохраните и закройте файл.

15. Настройка шифрования **SSL/TLS**
```
sudo nano /etc/dovecot/conf.d/10-ssl.conf
```
Найдите следующие две строки
```c
ssl_cert = </etc/pki/dovecot/certs/dovecot.pem
ssl_key = </etc/pki/dovecot/private/dovecot.pem
```
Нам нужно заменить значения местоположением вашего сертификата SSL/TLS и закрытого ключа. Не забудьте символ **<**. Это необходимо.  **НЕ ОБЯЗАТЕЛЬНО! Только, если сервер доступен из Internet и имеет реальный домен. В остальных случаях это редактирование необходимо пропустить**.
```
ssl_cert = </etc/letsencrypt/live/mail.your-domain.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.your-domain.com/privkey.pem
```

16. Найдите следующую строку и раскомментьте ее. (Удалите начальный символ **`#`**.)
```bash
#ssl_dh = </etc/dovecot/dh.pem
```

17. Найдите следующую строку.
```bash
#ssl_min_protocol = TLSv1
```
Это определяет минимальные версии **TLS**, используемые Dovecot. **TLSv1.0** и **TLSv1.1** небезопасны. поэтому раскомментировать эту строку и измените значение на **TLSv1.2**, что заставит Dovecot использовать **TLSv1.2** или **TLSv1.3**.
```bash
ssl_min_protocol = TLSv1.2
```

18. Найдите следующую строку.
```bash
#ssl_prefer_server_ciphers = no
```
Рекомендуется предпочесть порядок шифров сервера клиентскому, поэтому раскомментируйте эту строку и измените значение на yes.
```bash
ssl_prefer_server_ciphers = yes
```
Сохраните и закройте файл. 

19. Теперь нам нужно сгенерировать параметр **Диффи-Хеллмана** с помощью:
```bash
sudo openssl dhparam -out /etc/dovecot/dh.pem 4096
```
Если ваш почтовый сервер имеет одно ядро процессора, то это займет много времени (около 10 минут).
>Хотя существует несколько протоколов, которые предоставляют гарантии безопасности, хорошие требуют, чтобы стороны договорились о каком-либо общем секрете, прежде чем любые пользовательские данные могут быть зашифрованы и защищены целостностью.
>Существует два метода, обычно используемых для согласования общих секретов: попросите одну сторону использовать какой-то долгосрочный асимметричный ключ для шифрования секрета и отправки его владельцу ключа (как при обмене ключами RSA), или попросите обе стороны обмениваться сообщениями, которые способствуют вычисленному общему секрету (То, что мы называем обменом ключами Диффи-Хеллмана).
Безопасность обоих методов зависит от выбора правильных чисел. В одном варианте обмена ключами Диффи-Хеллмана одним из параметров должно быть большое простое число. Поскольку обмен ключами уязвим для атак, если число не является простым или не является особым простым, команда Red Hat Crypto разработала инструмент для математического доказательства того, что числа, которые мы распространяем, действительно являются простыми числами этого специального типа и, следовательно, не являются самым слабым звеном в безопасности систем, которые зависят от них. 
https://www.redhat.com/en/blog/understanding-and-verifying-security-diffie-hellman-parameters
https://ru.wikipedia.org/wiki/Протокол_Диффи_—_Хеллмана


20. Аутентификация **SASL** между Postfix и Dovecot
```bash
sudo nano /etc/dovecot/conf.d/10-master.conf
```
Измените раздел аутентификации службы на следующий, чтобы Postfix мог найти сервер аутентификации Dovecot. Пожалуйста, будьте осторожны с синтаксисом. Каждая открывающая скобка должна быть прекращена закрывающей скобкой.
```c
service auth {
    unix_listener /var/spool/postfix/private/auth {
      mode = 0600
      user = postfix
      group = postfix
    }
}
```
Сохраните и закройте файл. 
>**SASL (англ. Simple Authentication and Security Layer — простой уровень аутентификации и безопасности)** — это фреймворк (каркас) для предоставления аутентификации и защиты данных в протоколах на основе соединений. Он разделяет механизмы аутентификации от прикладных протоколов, в теории позволяя любому механизму аутентификации, поддерживающему SASL, быть использованным в любых прикладных протоколах, которые используют SASL. Фреймворк также предоставляет слой защиты данных. Для использования SASL протокол включает команду для идентификации и аутентификации пользователя на сервере и для опциональной защиты переговоров последующей интерактивности протокола. Если это используется в переговорах, то слой безопасности вставляется между протоколом и соединением.


21.  Автоматическое создание папок **Sent** и **Trash**
```bash
sudo nano /etc/dovecot/conf.d/15-mailboxes.conf
```
Чтобы автоматически создать папку, просто добавьте следующую строку в раздел почтового ящика.
```bash
auto = create
```
Пример:
```c
 mailbox Trash {
    auto = create
    special_use = \Trash
 }
```
Некоторые распространенные папки, которые вы хотите создать, включают в себя: **Drafts**, **Junk**, **Trash** и **Sent**. Папка "**Отправлено**" будет создана в домашнем каталоге пользователя, когда пользователь отправит первое электронное письмо. Папка "**Корзина**" будет создана, когда пользователь впервые удалит электронное письмо и т. д. После сохранения и закрытия всех вышеперечисленных конфигурационных файлов перезапустите Postfix и Dovecot.

22. **Подключитесь к серверу `s2-deb`**. Установите почтовый клиент **Thunderbird**.

23. Запустите свой настольный почтовый клиент, такой как Mozilla Thunderbird. Перейдите в **Edit -> Account Settings -> Account Actions -> Add Mail Account**, чтобы добавить учетную запись почты. Если Thunderbird нашел конфигурацию вашего почтового сервера, как показано ниже, просто нажмите кнопку Готово, и вы сможете читать и отправлять электронные письма. Добавьте учетную запись **sa@yourdomain.com** и **linda@yourdomaun.com** (предварительно на сервере **s1-alma** создаейте этого пользователя или используйте любую другую локальную учетную запись, созданную ранее, например **bob** - не забудьте задать пароль для пользовательского аккаунта). Если будет сообщение об ошибке самоподписанного сертификата - подтвердите доверие этому сертификату.
![thunderbird](/img/lab10-45.png)

24. Создайте и отправьте письмо от **sa** пользователю **linda**. Убедитесь, что письмо пришло.
